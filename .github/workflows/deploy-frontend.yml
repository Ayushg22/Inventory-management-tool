name: Deploy Frontend to Firebase

on:
  push:
    branches: [ main, master , feature ]
    paths:
      - 'inventory-frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  pull_request:
    branches: [ main, master , feature ]
    paths:
      - 'inventory-frontend/**'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: inventory-frontend/package-lock.json

    - name: Install dependencies
      run: |
        cd inventory-frontend
        npm ci

    - name: Build React app
      run: |
        cd inventory-frontend
        npm run build

    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Set up Firebase CLI
      run: |
        npm install -g firebase-tools

    - name: Deploy to Firebase
      run: |
        # Set up service account authentication for Firebase
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/service-account.json
        export GOOGLE_APPLICATION_CREDENTIALS="/tmp/service-account.json"
        # Change to frontend directory and verify firebase.json exists
        cd inventory-frontend
        pwd
        ls -la firebase.json
        # Set Firebase project explicitly
        firebase use ${{ secrets.GCP_PROJECT_ID }}
        # Deploy using service account authentication
        firebase deploy --only hosting --project ${{ secrets.GCP_PROJECT_ID }} --token "$(gcloud auth print-access-token)"

    - name: Show Deployment URL
      run: |
        echo "Frontend deployed at: https://nice-height-460409-m5.web.app"
